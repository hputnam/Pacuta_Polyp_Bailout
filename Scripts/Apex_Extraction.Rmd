---
title: "Apex_Data_Extraction"
author: "HM Putnam"
date: "2024-12-09"
output: html_document
---

Load Libraries
```{r}
library("XML")
library("plyr")
library("lubridate")
library("dplyr")
library("tidyverse")
```


Read in xml info
```{r}
apex.xmlfile <- xmlParse("http://10.10.204.74/cgi-bin/datalog.xml?sdate=250704&days=10") #read in the date (e.g. 180620) plus # days (e.g. days=4) of Apex data
Apex.Data.apex <- ldply(xmlToList(apex.xmlfile), data.frame) #convert xml to dataframe

#Tmp_1 = probe.value
#Cond_1 = probe.value.1
#pH_1 = probe.value.5

Apex.Data.apex <- Apex.Data.apex %>%
  select(c(date, probe.value, probe.value.1, probe.value.5))

colnames(Apex.Data.apex) <- c("date", "Tmp_1", "Cond_1", "pH_1")

#Check Current system time zone and time
current_tz <- Sys.timezone() 
print(current_tz)

# Set to correct timezone, time and correct date
#Sys.setenv(TZ = "UTC03:00") 
# correct_date <- Sys.Date()
# print(correct_date)
 
date <- Sys.Date() #set todays date
# time <- Sys.time()
# time <- gsub(":" ,"_",time)
# time <- gsub(" " ,"_",time)
# today <- sub('..', '', date)
# today <- gsub('-', '', today) 
# today <- as.numeric(today)
# 
write.csv(Apex.Data.apex, paste0("Data/",date,"_","Apex.Data.csv")) #write file to save data

```

Plot Apex temperature data
```{r}

str(Apex.Data)

Apex.Data <- Apex.Data %>%
  mutate(date = mdy_hms(date)) %>%  # Convert the date to a POSIXct datetime
  mutate(across(starts_with("Tank"), ~ as.numeric(.)))  # Convert temperature columns to numeric

Apex.Data_long <- Apex.Data %>%
  pivot_longer(cols = starts_with("Tank"),
               names_to = "Tank",
               values_to = "Temperature")

Apex.Data_long <- na.omit(Apex.Data_long)

apex.data <- ggplot(Apex.Data_long, aes(x = date, y = Temperature, color = Tank)) +
  geom_point() +
  labs(x = "Time",
       y = "Temperature (°C)",
       color = "Tank") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
apex.data 

ggsave("Output/apex_temperatures.pdf", plot=apex.data, height=6, width=8)

```


```{r}
# Ensure that 'date' is in the correct time zone (America/New_York)
Apex.Data_long.TZ <- Apex.Data_long %>%
  mutate(date = with_tz(date, tzone = "HST"))

# Now filter the data after 2024-12-01 00:00:00
apex.data.tz <- Apex.Data_long %>%
  filter(date >= ymd_hms("2024-12-19 00:00:00")) %>%
  ggplot(aes(x = date, y = Temperature, color = Tank)) +
  geom_point() +
  labs(x = "Time", y = "Temperature (°C)", color = "Tank") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
apex.data.tz 
```
