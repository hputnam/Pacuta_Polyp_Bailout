---
title: "Apex_Data_Extraction"
author: "HM Putnam updated by Thatcher Johnstone-Wright"
date: "2024-12-09"
output: html_document
---

Load Libraries
```{r}
library("XML")
library("plyr")
library("lubridate")
library("dplyr")
library("tidyverse")
library("ggpmisc")
library("gsw")
```


Read in xml info
```{r}
apex.xmlfile <- xmlParse("http://10.10.204.74/cgi-bin/datalog.xml?sdate=250819&days=1.5") #read in the date (e.g. 180620) plus # days (e.g. days=4) of Apex data
Apex.Data <- ldply(xmlToList(apex.xmlfile), data.frame) #convert xml to dataframe
```

# clean,  arrange, and save data
```{r}
# Select columns of interest by name from df
Apex.Data.apex <- Apex.Data %>%
  select(c(date, probe.value, probe.value.1, probe.value.4, probe.value.2, probe.value.3, probe.value.5, probe.value.7, probe.value.8, probe.value.6))

# Rename columns
colnames(Apex.Data.apex) <- c("date", "P_Cond_1", "P_Cond_2", "P_Tmp_2", "P_Tmp_1", "P_pH_1", "P_pH_2", "P_pH_3", "P_Cond_3", "P_Tmp_3")

# Check current system time zone and time
current_tz <- Sys.timezone()
print(current_tz)

# Convert date string to POSIXct with correct time zone
Apex.Data.apex <- Apex.Data.apex %>%
  mutate(date = as.POSIXct(date, format = "%m/%d/%Y %H:%M:%S", tz = "America/New_York"))

# Set today's date
date <- Sys.Date()

# Remove NAs
Apex.Data.apex <- na.omit(Apex.Data.apex)

# Format file name with today's date
today_date <- format(Sys.Date(), "%Y%m%d")

# Write cleaned data to CSV
write.csv(Apex.Data.apex, paste0("Data/", today_date, "_", "ApexRawData_.csv"), row.names = FALSE)


```

#Plot Apex data Cond, pH, and Temp
```{r}

#view dataframe attribues
str(Apex.Data.apex)

#convert date time to POSIXct datetime and probe data to numeric
Apex.Data.apex <- Apex.Data.apex %>%
  mutate(date = as.POSIXct(date, tz = "", format = "%m/%d/%Y %H:%M:%S")) %>%
  mutate(across(starts_with("P_"), ~ as.numeric(.)))

#view dataframe attribues
str(Apex.Data.apex)

#take the probe data columns and rearrange them into long format, with a column named probe and the numeric data in a column named value
Apex.Data_long <- Apex.Data.apex %>%
  pivot_longer(cols = starts_with("P_"),
               names_to = "probe",
               values_to = "value")
Apex.Data_long$Type <-Apex.Data_long$probe
Apex.Data_long$Type <- gsub("P_" ,"", Apex.Data_long$Type)
Apex.Data_long$Type <- gsub("_1" ,"", Apex.Data_long$Type)
Apex.Data_long$Type <- gsub("_2" ,"", Apex.Data_long$Type)
Apex.Data_long$Type <- gsub("_3" ,"", Apex.Data_long$Type)

str(Apex.Data_long)
unique(Apex.Data_long$probe)
unique(Apex.Data_long$Type)

# Plot data
apex.data <- ggplot(Apex.Data_long, aes(x = date, y = value, color = probe, group = Type)) +
  geom_point() +
  labs(x = "Time",
       y = "Value",
       color = "Probe") +
  facet_wrap(~ Type, scales = "free") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# Display plot
print(apex.data)


```


```{r}
# -----------------------------
# Define time intervals
# -----------------------------
start1 <- as.POSIXct("2025-07-21 09:14:00")
end1   <- as.POSIXct("2025-07-21 10:35:00")

start2 <- as.POSIXct("2025-07-21 10:53:00")
end2   <- as.POSIXct("2025-07-21 11:09:00")

start3 <- as.POSIXct("2025-07-21 11:11:00")
end3   <- as.POSIXct("2025-07-21 11:28:00")

# -----------------------------
# Load & subset for each time range
# -----------------------------
subset1 <- read.csv("Data/Calibration_Apex_Data_20250721.csv") %>%
  mutate(date = as.POSIXct(date, format = "%m/%d/%Y %H:%M:%S")) %>%
  filter(date >= start1 & date <= end1)

subset2 <- read.csv("Data/Calibration_Apex_Data_20250721.csv") %>%
  mutate(date = as.POSIXct(date, format = "%m/%d/%Y %H:%M:%S")) %>%
  filter(date >= start2 & date <= end2)

subset3 <- read.csv("Data/Calibration_Apex_Data_20250721.csv") %>%
  mutate(date = as.POSIXct(date, format = "%m/%d/%Y %H:%M:%S")) %>%
  filter(date >= start3 & date <= end3)

# -----------------------------
# Combine the subsets & add standards
# -----------------------------
subset_combined <- bind_rows(subset1, subset2, subset3)

subset_cond_probes <- subset_combined %>%
  select(date, P_Cond_1, P_Cond_2, P_Cond_3) %>%
  mutate(
    Standard = dplyr::case_when(
      date >= start1 & date <= end1 ~ 0,
      date >= start2 & date <= end2 ~ 53,
      date >= start3 & date <= end3 ~ 80,
      TRUE ~ NA_real_
    )
  ) %>%
  filter(!is.na(Standard))

# -----------------------------
# Bath calibrations: Standard ~ P_Cond_x
# (per-probe absolute ppt correction)
# -----------------------------
lm_cond1 <- lm(Standard ~ P_Cond_1, data = subset_cond_probes)
lm_cond2 <- lm(Standard ~ P_Cond_2, data = subset_cond_probes)
lm_cond3 <- lm(Standard ~ P_Cond_3, data = subset_cond_probes)

# Optional quick check
# plot(subset_cond_probes$P_Cond_2, subset_cond_probes$Standard)

# -----------------------------
# Apply bath corrections to full dataset
# (Assumes Apex.Data.apex already exists in env)
# -----------------------------
Apex.Data.apex$P_Cond_1_Corr <- coef(lm_cond1)[1] + coef(lm_cond1)[2] * Apex.Data.apex$P_Cond_1
Apex.Data.apex$P_Cond_2_Corr <- coef(lm_cond2)[1] + coef(lm_cond2)[2] * Apex.Data.apex$P_Cond_2
Apex.Data.apex$P_Cond_3_Corr <- coef(lm_cond3)[1] + coef(lm_cond3)[2] * Apex.Data.apex$P_Cond_3

# -----------------------------
# CHANGE: Align probe 3 to probe 2 (KEEP 1 CONSTANT)
# Fit alignment on the calibration subset using corrected values
# -----------------------------
subset_corr <- subset_cond_probes %>%
  mutate(
    P_Cond_1_Corr = coef(lm_cond1)[1] + coef(lm_cond1)[2] * P_Cond_1,
    P_Cond_2_Corr = coef(lm_cond2)[1] + coef(lm_cond2)[2] * P_Cond_2,
    P_Cond_3_Corr = coef(lm_cond3)[1] + coef(lm_cond3)[2] * P_Cond_3
  )

# Alignment model: make 3 look like 2
Ref_corr_3to2 <- lm(P_Cond_2_Corr ~ P_Cond_3_Corr, data = subset_corr)
coef_3to2 <- coef(Ref_corr_3to2)

# Apply alignment to full series
Apex.Data.apex$P_Cond_3_Corr2 <- coef_3to2[1] + coef_3to2[2] * Apex.Data.apex$P_Cond_3_Corr

# Keep probe 2 as its bath-corrected value (no extra scaling needed)
Apex.Data.apex$P_Cond_2_Corr2 <- Apex.Data.apex$P_Cond_2_Corr

# Probe 1 remains as-is (control)
# Apex.Data.apex$P_Cond_1_Corr already computed; no alignment

# -----------------------------
# Clean output
# -----------------------------
Apex.Corrected <- Apex.Data.apex %>%
  select(date, P_Cond_1_Corr, P_Cond_2_Corr2, P_Cond_3_Corr2)

# Diagnostics (optional)
# summary(Ref_corr_3to2)
# head(Apex.Corrected)

```

# pH Probe Cross Calibration 2 to 1
```{r}
str(Apex.Data.apex)

Apex.Data.apex$P_pH_1 <- as.numeric(Apex.Data.apex$P_pH_1)
Apex.Data.apex$P_pH_2 <- as.numeric(Apex.Data.apex$P_pH_2)

Ref_p_2 <- Apex.Data.apex %>%
  lm(P_pH_1 ~ P_pH_2, data = .)

coef(Ref_p_2)

summary(Apex.Data.apex %>%
  lm(P_pH_1 ~ P_pH_2, data = .))

coeffs <- coef(Ref_p_2)
r_squared <- summary(Ref_p_2)$r.squared

eq_label <- sprintf("y = %.2f + %.2fx, R² = %.3f", coeffs[1], coeffs[2], r_squared)


ggplot(Apex.Data.apex, aes(x = P_pH_2, y = P_pH_1)) +
  geom_point(color = "blue", alpha = 0.6) +
  geom_smooth(method = "lm", se = FALSE, color = "red", linetype = "dashed") +
  #annotate("text", x = 2, y = 60, label = eq_label, hjust = 0, size = 5)+
    geom_smooth(method = "lm", se = FALSE, color = "red", linetype = "dashed") +
  stat_poly_eq(
    aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")),
    formula = y ~ x,
    parse = TRUE,
    label.x.npc = "left", label.y.npc = 0.95,
    size = 5,
    color = "black"
  ) 
  labs(
    title = "Linear Regression: P_pH_2 vs P_pH_1",
    x = "P_pH_2",
    y = "P_pH_1"
  ) +
  theme_minimal()




```

#Correcting pH Probe 2 to Reference pH Probe 1

```{r}

#P_pH_1 = Reference probe
#y=5.71+0.37x

#correct the probe for the relationship (y=mx+b) with the reference probe
Apex.Data.apex$P_pH_2_Corr <- coeffs[1]+(coeffs[2]*Apex.Data.apex$P_pH_2)

Apex.Data.apex$test_pH_2 <- Apex.Data.apex$P_pH_2_Corr - Apex.Data.apex$P_pH_1
mean(Apex.Data.apex$test_pH_2)

ggplot(Apex.Data.apex, aes(x = P_pH_1, y = P_pH_2_Corr)) +
  geom_point(color = "blue", alpha = 0.6) +
  geom_smooth(method = "lm", se = FALSE, color = "red", linetype = "dashed") +
  #annotate("text", x = 2, y = 60, label = eq_label, hjust = 0, size = 5)+
  labs(
    title = "Linear Regression: P_pH_2 vs P_pH_2_Corr",
    x = "P_pH_1",
    y = "P_pH_2_Corr"
  ) +
  theme_minimal()




``` 

# pH Probe Cross Calibration 3 to 1
```{r}
str(Apex.Data.apex)

Apex.Data.apex$P_pH_1 <- as.numeric(Apex.Data.apex$P_pH_1)
Apex.Data.apex$P_pH_3 <- as.numeric(Apex.Data.apex$P_pH_3)

Ref_p_3 <- Apex.Data.apex %>%
  lm(P_pH_1 ~ P_pH_3, data = .)

coef(Ref_p_3)

summary(Apex.Data.apex %>%
  lm(P_pH_1 ~ P_pH_3, data = .))

coeffs <- coef(Ref_p_3)
r_squared <- summary(Ref_p_3)$r.squared

eq_label <- sprintf("y = %.2f + %.2fx, R² = %.3f", coeffs[1], coeffs[2], r_squared)


ggplot(Apex.Data.apex, aes(x = P_pH_3, y = P_pH_1)) +
  geom_point(color = "blue", alpha = 0.6) +
  geom_smooth(method = "lm", se = FALSE, color = "red", linetype = "dashed") +
  #annotate("text", x = 2, y = 60, label = eq_label, hjust = 0, size = 5)+
    geom_smooth(method = "lm", se = FALSE, color = "red", linetype = "dashed") +
  stat_poly_eq(
    aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")),
    formula = y ~ x,
    parse = TRUE,
    label.x.npc = "left", label.y.npc = 0.95,
    size = 5,
    color = "black"
  ) 
  labs(
    title = "Linear Regression: P_pH_3 vs P_pH_1",
    x = "P_pH_3",
    y = "P_pH_1"
  ) +
  theme_minimal()




```

#Correcting pH Probe 3 to Reference pH Probe 1

```{r}

#P_pH_1 = Reference probe

#correct the probe for the relationship (y=mx+b) with the reference probe
Apex.Data.apex$P_pH_3_Corr <- coeffs[1]+(coeffs[2]*Apex.Data.apex$P_pH_3)

Apex.Data.apex$test_pH_3 <- Apex.Data.apex$P_pH_3_Corr - Apex.Data.apex$P_pH_1
mean(Apex.Data.apex$test_pH_3)

ggplot(Apex.Data.apex, aes(x = P_pH_1, y = P_pH_3_Corr)) +
  geom_point(color = "blue", alpha = 0.6) +
  geom_smooth(method = "lm", se = FALSE, color = "red", linetype = "dashed") +
  #annotate("text", x = 2, y = 60, label = eq_label, hjust = 0, size = 5)+
  labs(
    title = "Linear Regression: P_pH_1 vs P_pH_3_Corr",
    x = "P_pH_1",
    y = "P_pH_3_Corr"
  ) +
  theme_minimal()




``` 

# Create Data set with Date and Time and corrected probe
```{r}


# --- Time window (your style) ---
start_time <- as.POSIXct("2025-08-14 08:51:00")
end_time   <- as.POSIXct("2025-08-15 09:15:00")

# Subset the full dataset to the time window
Apex.Sub <- Apex.Data.apex %>%
  filter(date >= start_time & date <= end_time)

# --- Make Final Data Set from the subset ---
Apex.Final <- Apex.Sub %>%
  select(
    date,
    P_Cond_1_Corr, P_Cond_2_Corr2, P_Cond_3_Corr2,
    P_Tmp_1, P_Tmp_2, P_Tmp_3,
    P_pH_1, P_pH_2_Corr, P_pH_3_Corr
  )

# Rename columns for plotting
colnames(Apex.Final) <- c(
  "date",
  "P_Cond_1", "P_Cond_2", "P_Cond_3",
  "P_Tmp_1", "P_Tmp_2", "P_Tmp_3",
  "P_pH_1", "P_pH_2", "P_pH_3"
)

# Long format + probe type
Apex.Data_long <- Apex.Final %>%
  pivot_longer(
    cols = -date,
    names_to = "probe",
    values_to = "value"
  ) %>%
  mutate(
    Type = case_when(
      grepl("Cond", probe) ~ "Conductivity",
      grepl("Tmp", probe)  ~ "Temperature",
      grepl("pH",  probe)  ~ "pH",
      TRUE ~ "Other"
    )
  )

# Plot
apex.data <- ggplot(Apex.Data_long, aes(x = date, y = value, color = probe, group = probe)) +
  geom_point() +
  labs(x = "Time", y = "Value", color = "Probe") +
  facet_wrap(~ Type, scales = "free") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

print(apex.data)
ggsave(
  filename = paste0("Outputs/apex_probes_", format(Sys.time(), "%Y%m%d_%H%M%S"), ".pdf"),
  plot = apex.data,
  height = 6, width = 8)
```



#salinity Calculation and column
```{r}


Apex.Final <- Apex.Final %>%
  mutate(
    Sal_1 = gsw_SP_from_C(C = P_Cond_1, t = P_Tmp_1, p = 0),
    Sal_2 = gsw_SP_from_C(C = P_Cond_2, t = P_Tmp_2, p = 0),
    Sal_3 = gsw_SP_from_C(C = P_Cond_3, t = P_Tmp_3, p = 0)
  )



head(Apex.Final)


```


# Visualizing Data from the trial/Filter time points
```{r} 
# Visualizing Data from the trial/Filter time points (COMBINED + exclude 1 bad window)
```{r}
start_time <- as.POSIXct("2025-08-14 08:51:00")
end_time   <- as.POSIXct("2025-08-15 09:15:00")

# --- Define the one bad window you want to remove ---
bad_start <- as.POSIXct("2025-08-14 12:00:00")  # <-- change to your bad window
bad_end   <- as.POSIXct("2025-08-14 13:00:00")

# Filter to main window, then drop the bad slice
filtered_data <- Apex.Final %>%
  filter(date >= start_time & date <= end_time) %>%
  filter(!(date >= bad_start & date <= bad_end))

# Long data for salinity, temp, and pH
sal_long <- filtered_data %>%
  pivot_longer(cols = starts_with("Sal_"),
               names_to = "Chamber",
               values_to = "value") %>%
  mutate(Type = "Salinity")

tmp_long <- filtered_data %>%
  pivot_longer(cols = starts_with("P_Tmp_"),
               names_to = "Chamber",
               values_to = "value") %>%
  mutate(Type = "Temperature")

ph_long <- filtered_data %>%
  pivot_longer(cols = starts_with("P_pH_"),
               names_to = "Chamber",
               values_to = "value") %>%
  mutate(Type = "pH")

# Combine and add time since start
combined_long <- bind_rows(sal_long, tmp_long, ph_long) %>%
  mutate(Time_Hours = as.numeric(difftime(date, min(date), units = "hours")))

# Slopes for salinity
slopes <- combined_long %>%
  filter(Type == "Salinity") %>%
  group_by(Chamber) %>%
  do({
    model <- lm(value ~ Time_Hours, data = .)
    data.frame(Slope = coef(model)[["Time_Hours"]])
  })

# Combined plot
combined_plot <- ggplot(combined_long, aes(x = Time_Hours, y = value, color = Chamber)) +
  geom_point() +
  geom_smooth(
    data = combined_long %>% filter(Type == "Salinity"),
    method = "lm", se = FALSE
  ) +
  labs(
    title    = "Sensors Over Time by Probe (Filtered, bad window removed)",
    subtitle = paste0("From ", format(start_time, "%Y-%m-%d %H:%M"),
                      " to ", format(end_time, "%Y-%m-%d %H:%M")),
    x = "Time (hours since start)",
    y = "Value"
  ) +
  facet_wrap(~ Type, scales = "free_y") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

print(combined_plot)

ggsave(
  filename = paste0("Outputs/apex_combined_Sal_Tmp_pH_", format(Sys.time(), "%Y%m%d_%H%M%S"), ".pdf"),
  plot = combined_plot,
  height = 6, width = 8
)



``` 
